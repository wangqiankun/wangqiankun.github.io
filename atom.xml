<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Qiankun's Blog]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://wangqiankun.github.io/"/>
  <updated>2015-10-13T08:06:47.000Z</updated>
  <id>http://wangqiankun.github.io/</id>
  
  <author>
    <name><![CDATA[WangQiankun]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Gradle自动构建]]></title>
    <link href="http://wangqiankun.github.io/2015/10/13/tools/Gradle%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA/"/>
    <id>http://wangqiankun.github.io/2015/10/13/tools/Gradle自动构建/</id>
    <published>2015-10-13T08:06:11.000Z</published>
    <updated>2015-10-13T08:06:47.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>构建跟打包有天壤之别，一句命令可以打成你想要的各种包<br>可灵活配置生产与测试环境的差异…等<br>牛逼之处，远不止于此</p>
</blockquote>
<ol>
<li>在项目目录中先执行 ‘./gradlew clean’ 如果提示没权限 则使用 ‘sudo ./gradlew clean’</li>
<li>Mac可能会提示 ‘sudo: ./gradlew: command not found’ ，意思大概为文件为非可执行状态,先执行 ‘chmod 755 gradlew’ 修改文件属性后，再执行此语句</li>
<li>执行 ‘./gradle build’ 会生成debug和release两个包</li>
<li>生成的app在/项目/app/build/outputs/apk下</li>
</ol>
<ul>
<li><p>如果之前未使用过gradle构建项目，一般会从新下载gradle包，无论之前是否使用过。（不过构建下载后，全部的项目都不用再下载gradle了）</p>
<p>下载时间较久，耐心等待………………你会懂得为什么这么多…</p>
</li>
</ul>
<h3 id="涉及到的功能点">涉及到的功能点</h3><h4 id="android_{}_中的(自上至下，顺序很重要)">android {} 中的(自上至下，顺序很重要)</h4><ol>
<li><p>defaultConfig为默认配置，其中任何配置都可被其他模块替换滴</p>
</li>
<li><p>// 签名文件配置（为保证安全，可创建signing.properties文件，在该文件配置路径,向下翻）</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">signingConfigs</span> &#123;</span><br><span class="line">   <span class="tag">debug</span> &#123;&#125;</span><br><span class="line">   <span class="tag">release</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置不同版本buildTypes模块（会对应生成名为BuildConfig的文件）,如下</p>
<blockquote>
<p>其中buildConfigField(“boolean”, “LOG_DEBUG”, “true”)是自定义语句</p>
</blockquote>
<p>语法buildConfigField(“类型（同JAVA）”,”名字”,”值”)</p>
<p>使用方法 public final static String LOG_DEBUG = BuildConfig.LOG_DEBUG;        </p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">   debug&#123;</span><br><span class="line">       <span class="comment">// 版本名前缀</span></span><br><span class="line">       versionNameSuffix <span class="string">"-debug"</span></span><br><span class="line">       buildConfigField(<span class="string">"boolean"</span>, <span class="string">"LOG_DEBUG"</span>, <span class="string">"true"</span>)</span><br><span class="line">       buildConfigField <span class="string">"String"</span>, <span class="string">"BASE_URL"</span>, <span class="string">"\"http://192.168.1.224:8080/\""</span></span><br><span class="line">       buildConfigField <span class="string">"String"</span>, <span class="string">"BASE_IMG_URL"</span>, <span class="string">"\"http://192.168.1.233:8888/dd-file-gw/\""</span></span><br><span class="line">       minifyEnabled <span class="literal">false</span></span><br><span class="line">       zipAlignEnabled <span class="literal">false</span></span><br><span class="line">       shrinkResources <span class="literal">false</span></span><br><span class="line">       signingConfig signingConfigs.debug</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   release &#123;</span><br><span class="line">       <span class="comment">// 版本名前缀</span></span><br><span class="line">       versionNameSuffix <span class="string">"-relase"</span></span><br><span class="line">       <span class="comment">//牛逼哄哄的选择是否输出LOG信息</span></span><br><span class="line">       buildConfigField(<span class="string">"Boolean"</span>, <span class="string">"LOG_DEBUG"</span>, <span class="string">"false"</span>)</span><br><span class="line">       <span class="comment">//牛逼哄哄的设置BASE_URL</span></span><br><span class="line">       buildConfigField <span class="string">"String"</span>, <span class="string">"BASE_URL"</span>, <span class="string">"\"http://mobile.zufangzi.com/\""</span></span><br><span class="line">       <span class="comment">//牛逼哄哄的设置BASE_IMG_URL</span></span><br><span class="line">       buildConfigField <span class="string">"String"</span>, <span class="string">"BASE_IMG_URL"</span>, <span class="string">"\"http://static.zufangzi.com/\""</span></span><br><span class="line">       <span class="comment">//牛逼哄哄的选择是否混淆编译</span></span><br><span class="line">       minifyEnabled <span class="literal">false</span></span><br><span class="line">       <span class="comment">//牛逼哄哄的档案整理工具</span></span><br><span class="line">       zipAlignEnabled <span class="literal">true</span></span><br><span class="line">       <span class="comment">//牛逼哄哄的移除无用的资源文件</span></span><br><span class="line">       shrinkResources <span class="literal">true</span></span><br><span class="line">       signingConfig signingConfigs.release</span><br><span class="line">       proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改生成的最终文件名,如下</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">applicationVariants.all &#123; variant -&gt;</span><br><span class="line"> variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</span><br><span class="line">     <span class="keyword">def</span> outputFile = output.outputFile</span><br><span class="line">     <span class="keyword">if</span> (outputFile != <span class="keyword">null</span> &amp;&amp; outputFile.name.endsWith(<span class="string">'.apk'</span>)) &#123;</span><br><span class="line">         <span class="keyword">File</span> outputDirectory = <span class="keyword">new</span> <span class="keyword">File</span>(outputFile.parent);</span><br><span class="line">         <span class="keyword">def</span> fileName</span><br><span class="line">         <span class="keyword">if</span> (variant.buildType.name == <span class="string">"release"</span>) &#123;</span><br><span class="line">             fileName = <span class="string">"Butler.$&#123;defaultConfig.versionName&#125;.apk"</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             fileName = <span class="string">"Butler.$&#123;defaultConfig.versionName&#125;_beta.apk"</span></span><br><span class="line">         &#125;</span><br><span class="line">         output.outputFile = <span class="keyword">new</span> <span class="keyword">File</span>(outputDirectory, fileName)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="android_{}_下面的">android {} 下面的</h4></li>
<li><p>使用signing.properties记录keyStore的地址以及密码</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">File</span> propFile = <span class="keyword">file</span>(<span class="string">'signing.properties'</span>);</span><br><span class="line"><span class="keyword">if</span> (propFile.exists()) &#123;</span><br><span class="line">   <span class="keyword">def</span> Properties props = <span class="keyword">new</span> Properties()</span><br><span class="line">   props.load(<span class="keyword">new</span> FileInputStream(propFile))</span><br><span class="line">   <span class="keyword">if</span> (props.containsKey(<span class="string">'STORE_FILE'</span>) &amp;&amp; props.containsKey(<span class="string">'STORE_PASSWORD'</span>) &amp;&amp;</span><br><span class="line">           props.containsKey(<span class="string">'KEY_ALIAS'</span>) &amp;&amp; props.containsKey(<span class="string">'KEY_PASSWORD'</span>)) &#123;</span><br><span class="line">       android.signingConfigs.release.storeFile = <span class="keyword">file</span>(props[<span class="string">'STORE_FILE'</span>])</span><br><span class="line">       android.signingConfigs.release.storePassword = props[<span class="string">'STORE_PASSWORD'</span>]</span><br><span class="line">       android.signingConfigs.release.keyAlias = props[<span class="string">'KEY_ALIAS'</span>]</span><br><span class="line">       android.signingConfigs.release.keyPassword = props[<span class="string">'KEY_PASSWORD'</span>]</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       android.buildTypes.release.signingConfig = <span class="keyword">null</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   android.buildTypes.release.signingConfig = <span class="keyword">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>signing.properties文件内容（该文件和key与src目录同级）</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="setting">STORE_FILE=<span class="value">jks路径</span></span></span><br><span class="line"><span class="setting">STORE_PASSWORD=<span class="value">看名字</span></span></span><br><span class="line"><span class="setting">KEY_ALIAS=<span class="value">看名字</span></span></span><br><span class="line"><span class="setting">KEY_PASSWORD=<span class="value">看名字</span></span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="我遇到过的错误">我遇到过的错误</h3><ul>
<li>sudo ./gradlew clean 出现错误</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> What went <span class="string">wrong:</span></span><br><span class="line">A problem occurred configuring root project <span class="string">'Butler'</span>.</span><br><span class="line">&gt; Could not resolve all dependencies <span class="keyword">for</span> configuration <span class="string">':classpath'</span>.</span><br><span class="line">   &gt; Cannot resolve external dependency com.android.tools.<span class="string">build:</span><span class="string">gradle:</span><span class="number">1.3</span><span class="number">.0</span> because no repositories are defined.</span><br><span class="line">     Required <span class="string">by:</span></span><br><span class="line">         :<span class="string">Butler:</span>unspecified</span><br></pre></td></tr></table></figure>
<p> x项目中有类似 classpath ‘io.fabric.tools:gradle:1.+’的语句，</p>
<p> 改成最新的版本，或者确定版本名就好。（类似gradle:1.20.0结尾）</p>
<ul>
<li><p>定义打包时间函数 (放在android{}之前)</p>
<p>def packageTime() {</p>
<p>  return new Date().format(“MM.dd”, TimeZone.getTimeZone(“UTC”))</p>
<p>}</p>
<p>使用方法：${packageTime()} 拼在字符串中</p>
</li>
</ul>
<ul>
<li><p>修改生成的最终文件名(放在android{}内最后)</p>
<p>  applicationVariants.all {</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">variant -&gt;</span><br><span class="line">    variant.outputs.<span class="keyword">each</span> &#123;</span><br><span class="line">        output -&gt;</span><br><span class="line">            <span class="keyword">def</span> outputFile = output.outputFile</span><br><span class="line">            <span class="keyword">if</span> (outputFile != <span class="keyword">null</span> &amp;&amp; outputFile.name.endsWith(<span class="string">'.apk'</span>)) &#123;</span><br><span class="line">                <span class="keyword">File</span> outputDirectory = <span class="keyword">new</span> <span class="keyword">File</span>(outputFile.parent);</span><br><span class="line">                <span class="keyword">def</span> fileName</span><br><span class="line">                <span class="keyword">if</span> (variant.buildType.name == <span class="string">"release"</span>) &#123;</span><br><span class="line">                    <span class="comment">// 输出apk名称为app_v1.0.0_2015-06-15_playStore.apk</span></span><br></pre></td></tr></table></figure>
<p>//                    fileName = “app<em>v${defaultConfig.versionName}</em>${packageTime()}_${variant.productFlavors[0].name}.apk”</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                fileName = <span class="string">"Butler_v<span class="subst">$&#123;defaultConfig.versionName&#125;</span>_<span class="subst">$&#123;packageTime()&#125;</span>.apk"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fileName = <span class="string">"Butler_v<span class="subst">$&#123;defaultConfig.versionName&#125;</span>_<span class="subst">$&#123;packageTime()&#125;</span>_beta.apk"</span></span><br><span class="line">            &#125;</span><br><span class="line">            output.outputFile = <span class="keyword">new</span> File(outputDirectory, fileName)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  }</p>
</li>
</ul>
<ul>
<li><p>报错</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="constant">Could </span><span class="keyword">not</span> resolve all dependencies <span class="keyword">for</span> configuration <span class="string">':classpath'</span>.</span><br><span class="line"> &gt; <span class="constant">Cannot </span>resolve external dependency com.android.tools.<span class="symbol">build:</span><span class="symbol">gradle:</span><span class="number">1.3</span>.<span class="number">0</span> because no repositories are <span class="keyword">defined</span>.</span><br><span class="line">   <span class="constant">Required </span><span class="symbol">by:</span></span><br><span class="line">       <span class="symbol">:Butler</span><span class="symbol">:unspecified</span></span><br></pre></td></tr></table></figure>
<p>解决地址： <a href="http://stackoverflow.com/questions/28921964/googles-android-basic-samples-code-broken-gradle-issues" target="_blank" rel="external">http://stackoverflow.com/questions/28921964/googles-android-basic-samples-code-broken-gradle-issues</a></p>
</li>
</ul>
<ul>
<li><p>报错</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">What</span> <span class="tag">went</span> <span class="rule"><span class="attribute">wrong</span>:<span class="value"></span><br><span class="line">Execution failed for task <span class="string">':app:lint'</span>.</span><br><span class="line">Lint found errors in the project</span></span>; <span class="tag">aborting</span> <span class="tag">build</span>.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>解决方法:</p>
<p>  Fix the issues identified by lint, or add the following to your build script to proceed with errors:</p>
<p>  …</p>
<p>  android {</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">lintOptions</span> &#123;</span><br><span class="line">    <span class="title">abortOnError</span> <span class="built_in">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  }</p>
<p>  …</p>
<ul>
<li><p>不知道什么原因不能调试了,报错如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Waiting <span class="keyword">for</span> device.</span><br><span class="line">Cannot debug <span class="type">application</span> com.dingding.butler <span class="function_start"><span class="keyword">on</span></span> device motorola-xt1085-TA09004RZM.</span><br><span class="line">This <span class="type">application</span> <span class="keyword">does</span> <span class="keyword">not</span> have <span class="keyword">the</span> debuggable attribute enabled <span class="keyword">in</span> <span class="keyword">its</span> manifest.</span><br><span class="line">If you have manually <span class="keyword">set</span> <span class="keyword">it</span> <span class="keyword">in</span> <span class="keyword">the</span> manifest, <span class="keyword">then</span> remove <span class="keyword">it</span> <span class="keyword">and</span> let <span class="keyword">the</span> IDE automatically assign <span class="keyword">it</span>.</span><br><span class="line">If you are using Gradle, make sure <span class="keyword">that</span> your current variant <span class="keyword">is</span> debuggable.</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<p>点击运行三角右边的机器人图标，选择’Edit Configurations…’–&gt;‘Defaults’</p>
<p>出来的列表，每个都点击，看着像有关系的选择框都点下选中，好了…不知道哪个起的作用</p>
</li>
</ul>
<p>有google到解决方法： Gradle下 release {‘这里添加 ‘debuggable true’’} 没试这个就好了</p>
<ul>
<li><p>无解BUG</p>
<p>自动生成的BuildConfig文件，默认为release状态的（可能看不懂这句话 自己写遍就知道了），</p>
<p>找了一下午，试了无数种方法，都不行！！！都不行！！！都不行！！！</p>
<p>最后无奈，重新down了一份代码，就好了啊！！！就好了啊！！！就好了啊！！！坑爹玩意儿！</p>
</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>构建跟打包有天壤之别，一句命令可以打成你想要的各种包<br>可灵活配置生产与测试环境的差异…等<br>牛逼之处，远不止于此</p>
</blockquote>
<ol>
<li>在项目目录中先执行 ‘./gradlew clean’ 如果提示没权限]]>
    </summary>
    
      <category term="Tools" scheme="http://wangqiankun.github.io/tags/Tools/"/>
    
  </entry>
  
</feed>
